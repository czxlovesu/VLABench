<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dataset Visualization</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nav-item.selected { background: #2d5fff; color: #fff; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="flex">
    <!-- Sidebar -->
    <div class="w-48 bg-white h-screen shadow-lg pt-6 flex flex-col">
      <div class="mb-3 text-lg ml-6 font-bold">üîé DATA NAV</div>
      <a href="#" id="nav-overview" class="nav-item px-6 py-3 block hover:bg-blue-50 selected">Overview</a>
      <a href="#" id="nav-taskvis" class="nav-item px-6 py-3 block hover:bg-blue-50">Task Visualization</a>
    </div>
    <!-- Main content -->
    <div class="flex-grow p-10">
      <div id="content-overview"></div>
      <div id="content-taskvis" style="display: none;"></div>
    </div>
  </div>
  <script>
    // ÂàáÊç¢ÂØºËà™
    document.getElementById('nav-overview').onclick = function(e) {
      e.preventDefault();
      this.classList.add('selected');
      document.getElementById('nav-taskvis').classList.remove('selected');
      document.getElementById('content-overview').style.display = '';
      document.getElementById('content-taskvis').style.display = 'none';
      loadOverview();
    };
    
    document.getElementById('nav-taskvis').onclick = function(e) {
      e.preventDefault();
      this.classList.add('selected');
      document.getElementById('nav-overview').classList.remove('selected');
      document.getElementById('content-overview').style.display = 'none';
      document.getElementById('content-taskvis').style.display = '';
      loadTaskVis(); 
    };

    // Overview SectionÔºàÊñá‰ª∂ÁªüËÆ°Ôºâ
    async function loadOverview() {
      try {
        let html = `<h1 class="text-2xl font-bold mb-6">üìä HDF5 Êñá‰ª∂ÁªüËÆ°</h1>
          <div id="primitive-section" class="mb-10">
            <h2 class="text-xl font-semibold mb-4">üß± Primitive Tasks</h2>
            <div id="primitive-results" class="space-y-2">Loading...</div>
          </div>
          <div id="composite-section">
            <h2 class="text-xl font-semibold mb-4">üß© Composite Tasks</h2>
            <div id="composite-results" class="space-y-2">Loading...</div>
          </div>`;
        document.getElementById('content-overview').innerHTML = html;
        
        const primitive = await fetch('/stats?type=primitive').then(res => res.json());
        const composite = await fetch('/stats?type=composite').then(res => res.json());
        
        console.log('Primitive stats:', primitive);
        console.log('Composite stats:', composite);
        
        function renderSection(data, containerId) {
          const container = document.getElementById(containerId);
          if (!data || Object.keys(data).length === 0) {
            container.innerHTML = '<div class="text-gray-500">No data available</div>';
            return;
          }
          
          const maxCount = Math.max(...Object.values(data));
          let html = '';
          for (const [folder, count] of Object.entries(data)) {
            const percent = maxCount === 0 ? 0 : (count / maxCount) * 100;
            html += `
              <div class="mb-3">
                <div class="flex justify-between text-sm mb-1">
                  <span>${folder}</span>
                  <span>${count} files</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-blue-500 h-3 rounded-full" style="width: ${percent}%;"></div>
                </div>
              </div>
            `;
          }
          container.innerHTML = html;
        }
        
        renderSection(primitive, 'primitive-results');
        renderSection(composite, 'composite-results');
      } catch (error) {
        console.error('Error loading overview:', error);
        document.getElementById('content-overview').innerHTML = `<div class="text-red-500">Error loading data: ${error.message}</div>`;
      }
    }

    // Task Visualization Section
    async function loadTaskVis() {
      try {
        let html = `<div>
          <h2 class="text-2xl font-bold mb-4">Task Visualization</h2>
          <div class="mb-4">
            <label class="mr-3 font-medium">Choose Type:</label>
            <select id="select-type" class="border rounded px-3 py-2 mr-2">
              <option value="primitive">Primitive</option>
              <option value="composite">Composite</option>
            </select>
            
            <label class="mr-3 font-medium">Task:</label>
            <select id="select-task" class="border rounded px-3 py-2 mr-2">
              <option value="">Loading...</option>
            </select>
            
            <label class="mr-3 font-medium">File:</label>
            <select id="select-file" class="border rounded px-3 py-2 mr-2">
              <option value="">Select task first</option>
            </select>
            
            <button id="load-task-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Load</button>
          </div>
          <div id="taskvis-result" class="mt-6"></div>
        </div>`;
        document.getElementById('content-taskvis').innerHTML = html;

        // ËΩΩÂÖ•‰ªªÂä°
        async function populateTasks() {
          try {
            const taskType = document.getElementById('select-type').value;
            console.log('Loading tasks for type:', taskType);
            
            const response = await fetch(`/tasks?type=${taskType}`);
            const tasks = await response.json();
            console.log('Tasks loaded:', tasks);
            
            const taskSelect = document.getElementById('select-task');
            if (!tasks || tasks.length === 0) {
              taskSelect.innerHTML = '<option value="">No tasks available</option>';
            } else {
              let options = '<option value="">Select a task...</option>';
              for(const task of tasks) {
                options += `<option value="${task}">${task}</option>`;
              }
              taskSelect.innerHTML = options;
            }
            
            // ÈáçÁΩÆÊñá‰ª∂ÈÄâÊã©
            document.getElementById('select-file').innerHTML = '<option value="">Select task first</option>';
          } catch (error) {
            console.error('Error loading tasks:', error);
            document.getElementById('select-task').innerHTML = '<option value="">Error loading tasks</option>';
          }
        }

        async function populateFiles() {
          try {
            const taskType = document.getElementById('select-type').value;
            const task = document.getElementById('select-task').value;
            
            if (!task) {
              document.getElementById('select-file').innerHTML = '<option value="">Select task first</option>';
              return;
            }
            
            console.log('Loading files for:', taskType, task);
            
            const response = await fetch(`/files?type=${taskType}&task=${task}`);
            const files = await response.json();
            console.log('Files loaded:', files);
            
            const fileSelect = document.getElementById('select-file');
            if (!files || files.length === 0) {
              fileSelect.innerHTML = '<option value="">No files available</option>';
            } else {
              let options = '<option value="">Select a file...</option>';
              for(const file of files) {
                options += `<option value="${file}">${file}</option>`;
              }
              fileSelect.innerHTML = options;
            }
          } catch (error) {
            console.error('Error loading files:', error);
            document.getElementById('select-file').innerHTML = '<option value="">Error loading files</option>';
          }
        }

        // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('select-type').onchange = populateTasks;
        document.getElementById('select-task').onchange = populateFiles;
        
        // Âä†ËΩΩHDF5ÂÜÖÂÆπ
        document.getElementById('load-task-btn').onclick = async function() {
          try {
            const type = document.getElementById('select-type').value;
            const task = document.getElementById('select-task').value;
            const file = document.getElementById('select-file').value;
            
            if (!type || !task || !file) {
              document.getElementById('taskvis-result').innerHTML = 
                '<div class="text-red-500">Please select type, task, and file</div>';
              return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('taskvis-result').innerHTML = 
              '<div class="text-blue-500">Loading HDF5 content...</div>';
            
            console.log('Loading HDF5 content for:', type, task, file);
            
            const response = await fetch(`/hdf5_content?type=${type}&task=${task}&file=${file}&n_frame=10`);
            const result = await response.json();
            console.log('HDF5 content loaded:', result);
            
            if (result.error) {
              document.getElementById('taskvis-result').innerHTML = 
                `<div class="text-red-500">Error: ${result.error}</div>`;
              return;
            }
            
            // Â±ïÁ§∫ instruction ÂíåËßÜÈ¢ëÂ∏ß
            let resultHtml = '';
            
            // ÊòæÁ§∫Êåá‰ª§
            if (result.instruction) {
              const instructionText = Array.isArray(result.instruction) ? 
                result.instruction.join(' ') : result.instruction;
              resultHtml += `
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                  <h3 class="font-bold text-lg mb-2">üìù Instruction:</h3>
                  <p class="text-blue-800">${instructionText}</p>
                </div>
              `;
            }
            
            if (result.views_data && result.views_data.length > 0) {
              resultHtml += `
                <div class="mb-4">
                  <h3 class="font-bold text-lg mb-3">üé¨ Multi-View Video (${result.n_views} views, showing ${result.views_data[0].frames.length} of ${result.total_frames} frames each):</h3>
              `;
              
              // ‰∏∫ÊØè‰∏™Êó∂Èó¥Ê≠•ÂàõÂª∫‰∏ÄË°åÔºåÊòæÁ§∫ÊâÄÊúâËßÜËßí
              const maxFrames = Math.max(...result.views_data.map(v => v.frames.length));
              
              for (let frameIdx = 0; frameIdx < maxFrames; frameIdx++) {
                resultHtml += `
                  <div class="mb-6">
                    <h4 class="text-md font-medium mb-2 text-gray-700">Frame ${frameIdx + 1}:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                `;
                
                // ÊòæÁ§∫Ëøô‰∏ÄÂ∏ßÁöÑÊâÄÊúâËßÜËßí
                result.views_data.forEach((viewData, viewIdx) => {
                  if (frameIdx < viewData.frames.length) {
                    resultHtml += `
                      <div class="text-center">
                        <img src="data:image/jpeg;base64,${viewData.frames[frameIdx]}" 
                            class="w-full h-32 object-cover rounded-lg shadow-lg border" 
                            alt="View ${viewIdx + 1}, Frame ${frameIdx + 1}"/>
                        <div class="text-sm text-gray-500 mt-1">View ${viewIdx + 1}</div>
                      </div>
                    `;
                  }
                });
                
                resultHtml += `
                    </div>
                  </div>
                `;
              }
              
              resultHtml += `</div>`;
            } else {
              resultHtml += `
                <div class="text-red-500 p-4 bg-red-50 rounded-lg">
                  ‚ùå No images found or error loading video frames.
                </div>
              `;
            }
            
            document.getElementById('taskvis-result').innerHTML = resultHtml;
            
          } catch (error) {
            console.error('Error loading HDF5 content:', error);
            document.getElementById('taskvis-result').innerHTML = 
              `<div class="text-red-500 p-4 bg-red-50 rounded-lg">Error loading content: ${error.message}</div>`;
          }
        };
        
        // È¶ñÊ¨°ËΩΩÂÖ•‰ªªÂä°ÂàóË°®
        await populateTasks();
        
      } catch (error) {
        console.error('Error initializing task visualization:', error);
        document.getElementById('content-taskvis').innerHTML = 
          `<div class="text-red-500">Error initializing: ${error.message}</div>`;
      }
    }
    
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
      loadOverview(); // ÈªòËÆ§ÊòæÁ§∫Ê¶ÇËßàÈ°µÈù¢
    });
    
    // Â¶ÇÊûúÈ°µÈù¢Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÁõ¥Êé•ÂàùÂßãÂåñ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadOverview);
    } else {
      loadOverview();
    }
  </script>
</body>
</html>